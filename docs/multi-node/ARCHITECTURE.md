# openGauss 多节点集群部署流程

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Docker Network                           │
│                  opengauss-network                          │
│                    172.18.0.0/16                            │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Primary    │  │  Standby1    │  │  Standby2    │     │
│  │              │  │              │  │              │     │
│  │ 172.18.0.10  │  │ 172.18.0.11  │  │ 172.18.0.12  │     │
│  │   Port:5432  │  │   Port:5432  │  │   Port:5432  │     │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘     │
│         │                 │                 │              │
│         │    Streaming    │    Streaming    │              │
│         │    Replication  │    Replication  │              │
│         └────────┬────────┴────────┬────────┘              │
│                  │                 │                       │
└──────────────────┼─────────────────┼───────────────────────┘
                   │                 │
         ┌─────────┼─────────────────┼─────────┐
         │         ▼                 ▼         │
         │    Port:15432        Port:15433     │  Host Machine
         │    (Primary)         (Standby1)     │
         │                 Port:15434          │
         │                 (Standby2)          │
         └─────────────────────────────────────┘
```

## 部署流程图

```
┌─────────────────┐
│ 1. 创建容器      │  01_create_containers.ps1 / .sh
│  - Docker网络   │  • 创建 opengauss-network (172.18.0.0/16)
│  - 3个容器节点  │  • opengauss-primary (172.18.0.10)
└────────┬────────┘  • opengauss-standby1 (172.18.0.11)
         │           • opengauss-standby2 (172.18.0.12)
         ▼
┌─────────────────┐
│ 2. SSH互信配置  │  02_setup_ssh.sh
│  - 安装SSH服务  │  • 在所有节点安装并启动 sshd
│  - 生成密钥对   │  • root 和 omm 用户生成 SSH 密钥
│  - 分发公钥     │  • 配置免密登录
└────────┬────────┘  • 验证节点间连接
         │
         ▼
┌─────────────────┐
│ 3. 初始化集群   │  03_init_cluster.sh
│  - 创建目录     │  • /home/omm/data, log, tmp, archivelog
│  - 初始化主节点 │  • gs_initdb 初始化主节点数据库
│  - 配置主节点   │  • postgresql.conf (WAL, 同步配置)
│  - 启动主节点   │  • pg_hba.conf (访问控制)
│  - 复制到备节点 │  • pg_basebackup 复制数据到备节点
└────────┬────────┘  • 配置 recovery.conf (备节点)
         │
         ▼
┌─────────────────┐
│ 4. 启动集群     │  04_start_cluster.sh
│  - 启动主节点   │  • gs_ctl start -Z single_node (主节点)
│  - 启动备节点1  │  • gs_ctl start -M standby (备节点1)
│  - 启动备节点2  │  • gs_ctl start -M standby (备节点2)
└────────┬────────┘  • 等待所有节点启动完成
         │
         ▼
┌─────────────────┐
│ 5. 验证集群     │  05_verify_cluster.sh
│  - 检查状态     │  • gs_ctl query (各节点状态)
│  - 复制状态     │  • pg_stat_replication (主备同步)
│  - 数据同步测试 │  • 主节点写入，备节点验证
│  - 只读验证     │  • 备节点写入测试(应失败)
└────────┬────────┘  • 延迟检查
         │
         ▼
┌─────────────────┐
│   集群就绪      │  ✓ 主节点可读写
│                 │  ✓ 备节点实时同步
│                 │  ✓ 备节点只读查询
└─────────────────┘  ✓ 自动故障切换准备
```

## 数据复制流程

```
┌──────────────────────────────────────────────────────────────┐
│                        主节点 (Primary)                       │
│                                                              │
│  ┌─────────┐                                                │
│  │ Client  │ ──── INSERT/UPDATE/DELETE ────▶                │
│  └─────────┘                                                │
│                                                              │
│       ▼                                                      │
│  ┌─────────────┐      ┌──────────────┐                     │
│  │ WAL Writer  │ ───▶ │  WAL Files   │                     │
│  └─────────────┘      └──────┬───────┘                     │
│                              │                              │
│                              │ WAL Streaming                │
└──────────────────────────────┼──────────────────────────────┘
                               │
              ┌────────────────┴────────────────┐
              ▼                                 ▼
┌──────────────────────────┐     ┌──────────────────────────┐
│   备节点1 (Standby1)      │     │   备节点2 (Standby2)      │
│                          │     │                          │
│  ┌────────────────┐     │     │  ┌────────────────┐     │
│  │ WAL Receiver   │     │     │  │ WAL Receiver   │     │
│  └───────┬────────┘     │     │  └───────┬────────┘     │
│          ▼              │     │          ▼              │
│  ┌────────────────┐     │     │  ┌────────────────┐     │
│  │ Recovery       │     │     │  │ Recovery       │     │
│  │ Process        │     │     │  │ Process        │     │
│  └───────┬────────┘     │     │  └───────┬────────┘     │
│          ▼              │     │          ▼              │
│  ┌────────────────┐     │     │  ┌────────────────┐     │
│  │ Data Files     │     │     │  │ Data Files     │     │
│  └────────────────┘     │     │  └────────────────┘     │
│                          │     │                          │
│  ┌─────────┐            │     │  ┌─────────┐            │
│  │ Client  │ ── SELECT  │     │  │ Client  │ ── SELECT  │
│  └─────────┘  (只读)    │     │  └─────────┘  (只读)    │
└──────────────────────────┘     └──────────────────────────┘
```

## 故障切换流程

```
正常运行:
┌─────────┐          ┌─────────┐          ┌─────────┐
│ Primary │ ════════▶│Standby1 │          │Standby2 │
│         │ 流复制   │         │          │         │
└─────────┘          └─────────┘          └─────────┘

主节点故障:
┌─────────┐          ┌─────────┐          ┌─────────┐
│ Primary │ ✖        │Standby1 │          │Standby2 │
│ (Down)  │          │         │          │         │
└─────────┘          └─────────┘          └─────────┘

执行故障切换 (gs_ctl failover):
┌─────────┐          ┌─────────┐          ┌─────────┐
│ Primary │          │Standby1 │          │Standby2 │
│ (Down)  │          │ ══▶ 提升 │          │         │
└─────────┘          │  为主节点│          └─────────┘
                     └─────────┘

新集群配置:
┌─────────┐          ┌─────────┐          ┌─────────┐
│ Primary │          │ Primary │ ════════▶│Standby2 │
│ (Down)  │          │  (新主) │ 流复制   │         │
└─────────┘          └─────────┘          └─────────┘

原主节点恢复为备节点:
┌─────────┐          ┌─────────┐          ┌─────────┐
│Standby  │◀════════ │ Primary │ ════════▶│Standby2 │
│ (降级)  │ 流复制   │  (新主) │ 流复制   │         │
└─────────┘          └─────────┘          └─────────┘
```

## 关键配置文件

### 主节点配置

**postgresql.conf**
```ini
wal_level = hot_standby              # 支持热备
max_wal_senders = 10                 # 最多10个发送进程
wal_keep_segments = 256              # 保留256个WAL段
synchronous_standby_names = 'ANY 1(standby1,standby2)'  # 任意1个同步
```

**pg_hba.conf**
```
host    replication     omm     172.18.0.0/16    trust
```

### 备节点配置

**recovery.conf**
```ini
standby_mode = 'on'
primary_conninfo = 'host=172.18.0.10 port=5432 user=omm'
recovery_target_timeline = 'latest'
```

## 监控和维护

### 检查主备同步状态

```sql
-- 在主节点执行
SELECT 
    application_name,
    client_addr,
    state,
    sync_state
FROM pg_stat_replication;
```

### 检查复制延迟

```sql
-- 在主节点执行
SELECT 
    application_name,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) as lag
FROM pg_stat_replication;
```

### 节点角色查询

```bash
# 查询节点是主节点还是备节点
gs_ctl query -D /home/omm/data
```
